 ## TCP传输控制协议

### 引言

* ARQ和重传
* 分组窗口和滑动窗口
* 流量控制和拥塞控制
* 设置重传超时



TCP提供面向连接的、可靠的字节流服务

面向连接意味着两个使用TCP的应用彼此交换数据之前必须先建立一个TCP连接

TCP通过下列方式提供可靠性：

应用数据被分割成TCP认为最适合发送的数据块，这与UDP不同。由TCP传递给IP的信息单位被称为报文段或段(segment)，**如何确定报文段长度？**

TCP发出一个段后，启动一个定时器，等待目的端确认收到这个报文段。如不能及时收到一个确认，将重发这个报文段，**TCP自适应超时与重传策略？**

TCP收到发自TCP连接另一端的数据，将发送一个确认，这个确认不是立即发送，通常将推迟几分之一秒，**为什么?**

TCP报文段到达可能会失序，如果必要，TCP将对收到的数据进行**重新排序**，将收到数据以正确顺序交给应用层。

IP数据报会发生重复，**TCP接收端必须丢弃重复的数据**

TCP提供**流量控制**，TCP连接的每一方都有固定大小的缓冲空间，TCP接收端只允许另一端发送接收端缓冲区所能容纳的数据，这将防止较快主机致使较慢主机缓冲区溢出。

**字节流**，两个应用程序通过TCP连接交换8bit字节构成的字节流。如一方应用程序先传10字节，再传20字节，再传50字节，连接耳袋另一方无法了解发方每次发送了多少字节，收方可以分4次接收这80字节

另外，TCP对字节流内容不作任何解释，不知道传输的数据字节流是位进制数据，还是ASCII字符或其他类型。对字节流的解释由TCP连接双方的应用层解释。

#### TCP首部

![image-20200404152214582](C:\Users\pc\AppData\Roaming\Typora\typora-user-images\image-20200404152214582.png)

TCP数据封装在IP数据报中，TCP首部20字节，后跟TCP数据

![image-20200404154642419](C:\Users\pc\AppData\Roaming\Typora\typora-user-images\image-20200404154642419.png)

每个TCP段都包含源端和目的端的端口号，用于寻找收端和发端的应用进程。

把一个IP地址和一个端口号称为socket， 插口对唯一确定互联网络中每个TCP连接的双方

序号用来标识从TCP发端向TCP收端发送的数据字节流，表示在这个报文段中的第一个数据字节，为无符号32位数

每个传输的字节都被计数，确认序号包含发送确认的一端所期望收到的下一个序号。因此确认序号应当是上次已成功收到数据字节序号加1，只有ACK标志为1时，确认序号字段有效。一旦某个连接建立，ACK字段总是被设置，标志为1

TCP为应用层提供**全双工**服务

TCP可以表述为**一个没有选择确认或否认的滑动窗口协议**。TCP缺少选择确认是因为TCP首部中确认符号表示发方已成功收到字节，但还不包含确认序号所指的字节。当前还无法对数据流中选定的部分进行确认。例如1-1024字节已经成功收到，下一报文段中包含2049-3072字节，收端不能确认这个新报文段，返回一个确认序号为1025的ACK。它也无法对一个报文段进行否认。如收到1025-2048字节的报文段，但它的检验和错，TCP接收端所能作的是发回一个确认序号为1025的ACK。

注:现代TCP有一个选择确认选项，允许收方告诉发方收到了杂乱的数据



6个标志比特

URG 紧急指针有效

ACK 确认序号有效

PSH 接收方应该尽快把这个报文段交给应用层

RST 重建连接

SYN 同步序号用来发起一个连接

FIN 发端完成发送任务

MSS(Maximum Segment Size)

最长报文大小， 每个连接方通常在通信的第一个报文段中指明该选项，表示本端所能接收的最大长度的报文段。



三路握手报文

服务端192.168.0.100:9877  IP c0a8 0064 端口 2695

客户端192.168.0.105:57438 IP c0a8 0069 端口 e05e

```C
root@ubuntu2:/home/pcjj600# tcpdump -i enp0s3 'port 9877' -X
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on enp0s3, link-type EN10MB (Ethernet), capture size 262144 bytes
// 三路握手
15:37:09.453259 IP 192.168.0.105.57438 > 192.168.0.100.9877: Flags [S], seq 118442796, win 29200, o, length 0
        0x0000:  4500 003c 1393 4000 4006 a50b c0a8 0069  E..<..@.@......i
        0x0010:  c0a8 0064 e05e 2695 070f 4b2c 0000 0000  ...d.^&...K,....
        0x0020:  a002 7210 a1d9 0000 0204 05b4 0402 080a  ..r.............
        0x0030:  000a 58bf 0000 0000 0103 0307            ..X.........
// IP首部: IP版本:4, IHL为5，8位服务类型为0, 总长度60字节(0x3c),16位标识1393, 3位标识0x10,13位片偏移0, TTL为0x40(64),8位协议0x06, 16位校验和a50b, 源IP地址c0a8 0069,目的IP地址c0a8 0064 
// TCP报文段源端口号:e05e, 目的端口号:2695, 32位序号:070f 4b2c, 32位确认号0000 0000, 4位首部长度0xa(10), 保留6位:0, 6位:000010b(SYN=1),16位窗口大小:7210(29200), 16位检验和:a1d9, 16位紧急指针0000,TCP选项数据    
            
15:37:09.453285 IP 192.168.0.100.9877 > 192.168.0.105.57438: Flags [S.], seq 4186043965, ack 118442r 678079,nop,wscale 7], length 0
        0x0000:  4500 003c 0000 4000 4006 b89e c0a8 0064  E..<..@.@......d
        0x0010:  c0a8 0069 2695 e05e f981 f63d 070f 4b2d  ...i&..^...=..K-
        0x0020:  a012 7120 824c 0000 0204 05b4 0402 080a  ..q..L..........
        0x0030:  0007 f0c0 000a 58bf 0103 0307            ......X.....
15:37:09.453979 IP 192.168.0.105.57438 > 192.168.0.100.9877: Flags [.], ack 1, win 229, options [no
        0x0000:  4500 0034 1394 4000 4006 a512 c0a8 0069  E..4..@.@......i
        0x0010:  c0a8 0064 e05e 2695 070f 4b2d f981 f63e  ...d.^&...K-...>
        0x0020:  8010 00e5 6137 0000 0101 080a 000a 58c0  ....a7........X.
        0x0030:  0007 f0c0
// 回射HelloWto
15:38:19.059022 IP 192.168.0.105.57438 > 192.168.0.100.9877: Flags [P.], seq 1:12, ack 1, win 229,
        0x0000:  4500 003f 1395 4000 4006 a506 c0a8 0069  E..?..@.@......i
        0x0010:  c0a8 0064 e05e 2695 070f 4b2d f981 f63e  ...d.^&...K-...>
        0x0020:  8018 00e5 132b 0000 0101 080a 000a 9cb9  .....+..........
        0x0030:  0007 f0c0 4865 6c6c 6f57 6f72 6c64 0a    ....HelloWorld.
15:38:19.059512 IP 192.168.0.100.9877 > 192.168.0.105.57438: Flags [.], ack 12, win 227, options [n
        0x0000:  4500 0034 06fe 4000 4006 b1a8 c0a8 0064  E..4..@.@......d
        0x0010:  c0a8 0069 2695 e05e f981 f63e 070f 4b38  ...i&..^...>..K8
        0x0020:  8010 00e3 8244 0000 0101 080a 0008 34b9  .....D........4.
        0x0030:  000a 9cb9                                ....
15:38:19.059953 IP 192.168.0.100.9877 > 192.168.0.105.57438: Flags [P.], seq 1:12, ack 12, win 227,
        0x0000:  4500 003f 06ff 4000 4006 b19c c0a8 0064  E..?..@.@......d
        0x0010:  c0a8 0069 2695 e05e f981 f63e 070f 4b38  ...i&..^...>..K8
        0x0020:  8018 00e3 824f 0000 0101 080a 0008 34b9  .....O........4.
        0x0030:  000a 9cb9 4865 6c6c 6f57 6f72 6c64 0a    ....HelloWorld.
15:38:19.061968 IP 192.168.0.105.57438 > 192.168.0.100.9877: Flags [.], ack 12, win 229, options [n
        0x0000:  4500 0034 1396 4000 4006 a510 c0a8 0069  E..4..@.@......i
        0x0010:  c0a8 0064 e05e 2695 070f 4b38 f981 f649  ...d.^&...K8...I
        0x0020:  8010 00e5 d92d 0000 0101 080a 000a 9cba  .....-..........
        0x0030:  0008 34b9                                ..4.                     // 被动关闭
15:40:10.820794 IP 192.168.0.105.57438 > 192.168.0.100.9877: Flags [F.], seq 12, ack 12, win 229, options [nop,nop,TS val 723421 ecr 537785], length 0
        0x0000:  4500 0034 1397 4000 4006 a50f c0a8 0069  E..4..@.@......i
        0x0010:  c0a8 0064 e05e 2695 070f 4b38 f981 f649  ...d.^&...K8...I
        0x0020:  8011 00e5 6c09 0000 0101 080a 000b 09dd  ....l...........
        0x0030:  0008 34b9                                ..4.
15:40:10.821200 IP 192.168.0.100.9877 > 192.168.0.105.57438: Flags [F.], seq 12, ack 13, win 227, options [nop,nop,TS val 565725 ecr 723421], length 0
        0x0000:  4500 0034 0700 4000 4006 b1a6 c0a8 0064  E..4..@.@......d
        0x0010:  c0a8 0069 2695 e05e f981 f649 070f 4b39  ...i&..^...I..K9
        0x0020:  8011 00e3 8244 0000 0101 080a 0008 a1dd  .....D..........
        0x0030:  000b 09dd                                ....
15:40:10.822379 IP 192.168.0.105.57438 > 192.168.0.100.9877: Flags [.], ack 13, win 229, options [nop,nop,TS val 723422 ecr 565725], length 0
        0x0000:  4500 0034 1398 4000 4006 a50e c0a8 0069  E..4..@.@......i
        0x0010:  c0a8 0064 e05e 2695 070f 4b39 f981 f64a  ...d.^&...K9...J
        0x0020:  8010 00e5 fee2 0000 0101 080a 000b 09de  ................
        0x0030:  0008 a1dd                                ....                                                                                                  
```

使用TCP的程序:

Telnet, Rlogin, FTP, SMTP