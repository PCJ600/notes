### IPV4地址

IPV4地址是给Internet上每一个主机或路由器每一个接口分配一个32比特的标识符

### 三个阶段

* 分类地址

* 划分子网

* 构造超网

### 分类地址

A类地址 8位网络号(0) + 24位主机号

B类地址 16位网络号(10) + 16位主机号

C类地址 24位网络号(110) + 8位主机号

### A类地址

0为保留的网络号

第一个可指派的网络号 1.0.0.0

本地换回测试地址 127.0.0.1 —— 127.255.255.254

最后一个可指派的网络号 126.0.0.0

### B类地址

第一个可指派的网络号 128.0.0.0

最后一个可指派网络号 191.255.0.0

### C类地址

第一个可指派的网络号：192.0.0.0

最后一个可指派的网络号：233.255.255.0

### D类地址

1110开头， 多播地址

### E类地址

1111开头，保留地址

### 划分子网

32比特的IP地址：网络号 + 子网号 + 主机号

### 构造超网

128.14.35.7/20

CIDR是网络前缀都相同的连续IP地址组成一个CIDR地址块

### 主机发送IP数据报的过程

![主机发送IP数据报的过程](C:\Users\pc\Desktop\learning\notes\notes\NetWork\湖科大\主机发送IP数据报的过程.PNG)

在ARP缓存中找到目的IP地址对应的MAC地址+

### 静态路由的路由环路问题

* 配置错误
* 聚合了不存在的网络 配置黑洞路由(下一跳设置为null0)
* 网络故障 断开连接

TTL值 —— 防止IP数据报永久兜圈

### 路由选择协议概述

#### 静态路由

* 由人工配置的特定主机路由,网络路由,默认路由,黑洞路由等都属于静态路由

* 配置简单,开销小,但不能适应网络状态的变化

* 一般只在小规模网络中采用

#### 动态路由

* 通过路由选择协议自动获取路由信息
* 比较复杂,开销比较大,能较好适应网络状态的变化

常见路由选择协议

* RIP 路由信息协议, 最早使用, 基于距离向量

* IGRP 内部网关路由协议, 已被EIGRP取代

* EIGRP 增强型内部网关路由协议

* OSPF 开放式最短路径优先, 基于链路状态,在各种网络中广泛使用

* IS-IS  中间系统到中间系统, ISP骨干网上最常用的IGP协议

外部网关协议EGP, 边界网关协议BGP

### 路由信息协议RIP

RIP是基于距离矢量D-V算法的协议,使用跳数(Hop Count)作为度量(Metric)来衡量到达目的网络的距离

* 默认情况下,路由器与到它直接相连的网络跳数为0, 因此距离为0
* 路由器到与它非直连网络的**距离等于中间所经过路由器的数量**
* 距离取值范围为0~15,等于或大于16的距离被定义为无穷大,即网络目的不可达

等价负载均衡

RIP报文封装在UDP，发送和接收端口为520

封装有RIP报文的UDP用户数据报封装在IP数据报中，目的IP地址为255.255.255.255

#### RIP路由条目更新规则

若收到的某路由条目在路由表中没有，直接添加，这是发现了新网络

若路由表中已有到达相同目的网络的路由表条目，按如下情况处理：

* 若来自相同下一跳路由器，则更新，因为这是到达该目的网络且下一跳相同的最新路由信息
* 若来自不同下一跳路由器，需比较距离

更新定时器：30秒(+随机偏移时间(-5 ~ +5))，每30秒向邻居路由器发起RIP更新。

失效定时器：180秒	标记PD，不删除

清除定时器：240秒

#### 问题：路由环路，收敛速度慢

**水平分割**（强制使用）：从某接口学习来的路由信息不能再从该接口发送出去，避免两个路由器间环路问题

**带毒化逆转的水平分割**（可选项）：从某接口学习来的路由信息可以再从该接口发送出去，但需要将距离更改为16，即不可达

**触发更新**: 只要路由条目被更新，立刻将该路由条目发送给邻居，不必等更新定时器到时

#### RIP无法完全避免路由环境

### 开放最短路径优先OSPF

O表示开放，表明OSPF协议不是受某一家厂商控制，而是公开发表的

最短路径优先，因为使用了Dijkstra的最短路径算法SPF

OSPF是基于链路状态的

采用SPF算法计算路由，算法上保证了不会产生路由环路

不限制网络规模，更新效率高，收敛速度快

分组使用IP数据报进行封装，协议号89,组播地址224.0.0.5,224.0.0.6

默认管理距离110，可手动修改

### 边界网关协议BGP

不同AS内，度量路由的代价可能不同

AS间路由选择必须考虑策略

BGP只能力求寻找一条能够到达目的网络且比较好的路由（不兜圈），而非寻找一条最佳路由

配置BGP时，每个AS的管理员选择至少一个路由器作为该AS的BGP发言人

不同AS的BGP发言人要交换路由信息，首先要建立TCP连接，端口号为179



### IPV4首部格式

固定20字节 + 可变40字节

版本号：4比特，取值为4或6

首部长度: 4比特，最小为5，最大为15

区分服务：8比特

总长度：16比特，IP数据报的总长度，包括首部 + 有效载荷，收到MTU大小限制

标识：16比特

* 属于同一个数据报的各分片具有相同的标识

* IP软件维持一个计数器，每产生一个数据报，计数器的值加１

标志: 3比特

* DF位, 1表示不允许分片
* MF位, 1表示后面还有分片
* 保留位1位,必须为0

片偏移: 13比特

* 分片的数据部分相对于其在原数据报数据部分的偏移量,以8字节为单位

生存时间: 8比特(TTL)

以跳数为单位,路由器转发IP数据报时,将IP数据报首部中的该字段减1,若不为0就转发,否则丢弃

协议: 8比特

| 协议名称   | ICMP | IGMP | TCP  | UDP  | IPV6 | OSPF |
| ---------- | ---- | ---- | ---- | ---- | ---- | ---- |
| 协议字段值 | 1    | 2    | 6    | 17   | 41   | 89   |

首部校验和: 8比特

* 只检验首部, 不包括数据部分
* 数据报每经过一个路由器, 都要重新计算首部校验和, 因为某些字段(生存时间,标志,片偏移)可能变化
* 由于IP层本身不提供可靠传输服务,且计算首部校验和是一项耗时的操作,因此IPV6中,路由器不再计算首部校验和,从而更快地转发IP数据报

源IP地址 + 目的IP地址: 8比特 + 8比特

可变部分 可变字段 + 填充

* 确保首部长度为4的倍数
* 全0填充

### 网际控制报文协议 ICMP

为了更有效地转发IP数据报和提高交付成功的机会,在网际层使用网际控制报文协议ICMP(Internet Control Message Protocol )

主机或路由器使用ICMP**差错报告报文和询问报文**

#### 四种常见的ICMP差错报告报文

* 终点不可达 

* 时间超过

* 参数问题

* 改变路由(重定向)

#### ICMP的应用举例

分组网间探测PING (Packet Internet Groper)

* 用来测试主机和路由器之间的连通性
* 直接使用网际层的ICMP, 不通过运输层

跟踪路由traceroute

用来测试IP数据报从源主机到达目的主机要经过哪些路由器

Windows版本

* tracert命令
* 应用层直接使用网际层ICMP

Unix版本

* traceroute命令
* 运输层使用UDP协议











































